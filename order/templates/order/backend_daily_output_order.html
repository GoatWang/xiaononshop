{% extends "order/layout.html" %}
{% load staticfiles %}


{% block scripts_top %}
{% endblock %}


{% block styles %}
<style>
    #searchInput{
        max-width: 300px;
    }
    
    h5{
        margin-left: 30px;
    }
    table{
        margin-left: 50px;
    }
</style>
{% endblock %}

{% block content %}
<h2>{{ title }}</h2>
<h4>出貨統計</h4>

<div class="row">
    {% for os in order_stats %}
    <h5>{{ os.dp }}</h5>
    <table class="table statsTable">
        <thead>
            <tr>
                <th>類別</th>
                <th>便當</th>
                <th>預定已領（個）</th>
                <th>預定未領（個）</th>
                <th>現場剩餘（個）</th>
                <th>當天總數（個）</th>
                <th hidden="hidden">bento_id</th>
            </tr>
        </thead>
        <tbody>
            {% for dp_limit in os.dp_limits %}
            <tr>
                <td>{{ dp_limit.type }}</td>
                <td>{{ dp_limit.bento }}</td>
                <td>{{ dp_limit.received }}</td>
                <td>{{ dp_limit.unreceived }}</td>
                <td>{{ dp_limit.remain }}</td>
                <td>{{ dp_limit.limitation }}</td>
                <td hidden = "hidden">{{ dp_limit.bento_id }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    {% endfor %}


</div>


<h4>出貨清單</h4>
<div class="row form-group">
    <label for="searchInput" class="col-sm-1 col-form-label">檢索</label>
    <div class="col-sm-11">
        <input type="text" class="form-control" id="searchInput" placeholder="電話後三碼">
    </div>
</div>
<div class="row">
    <table id="orderList" class="table">
        <thead>
            <tr>
                <th hidden="hidden">order_id</th>
                <th hidden="hidden">line_id</th>
                <th>Line名稱</th>
                <th>手機</th>
                <th hidden="hidden">phone_last3</th>
                <th>地點</th>
                <th>便當</th>
                <th>個數</th>
                <th>價格</th>
                <th>狀態</th>
                <th hidden="hidden">bento_id</th>
            </tr>
        </thead>
        <tbody>
            {% for order in order_list %}
            <tr>
                <td hidden="hidden">{{ order.order_id }}</td>
                <td hidden="hidden">{{ order.line_id }}</td>
                <td>{{ order.line_name }}</td>
                <td>{{ order.phone }}</td>
                <td hidden="hidden">{{ order.phone_last3 }}</td>
                <td>{{ order.distribution_place }}</td>
                <td>{{ order.bento_name }}</td>
                <td>{{ order.number }}</td>
                <td>{{ order.price }}</td>
                {% if not order.received %}
                <td><input class='btn btn-danger receiveBtn' type='button' value='未領取' /></td>
                {% else %}
                <td><input class='btn btn-default received' type='button' value='已領取' /></td>
                {% endif %}
                <td hidden = "hidden">{{ order.bento_id }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
{% block scripts %}
<script>
    $.ajaxSetup({
        headers: {
            "X-CSRFToken": '{{ csrf_token }}'
        }
    });

    $(".btn").click(function () {
        this_btn = $(this)
        order_id = $(this).parents('tr').eq(0).find('td').eq(0).text()
        order_number = $(this).parents('tr').eq(0).find('td').eq(7).text()
        distribution_place = $(this).parents('tr').eq(0).find('td').eq(5).text()
        bento = $(this).parents('tr').eq(0).find('td').eq(6).text()
        bento_id = $(this).parents('tr').eq(0).find('td').eq(10).text()
        current_td = $(this).parents('td').eq(0)
        order_id_int = parseInt(order_id)
        order_number_int = parseInt(order_number)
        bento_id_int = parseInt(bento_id)
        $.ajax({
            type: 'POST',
            url: '{% url "order:toggle_receive_bento" %}',
            data: {
                "order_id": JSON.stringify(order_id_int)
            },
            async: false,
            dataType: 'json',
            success: function (response) {
                // console.log(response.success)

                // Update number
                $(".statsTable").each(function () {
                    // console.log("每個ST:", $(this))
                    if ($(this).prev().text() === distribution_place) {
                        // console.log("如果DP與點擊相同:",$(this))
                        $(this).find("tbody tr").each(function () {
                            target_tr = $(this)
                            if (parseInt(target_tr.find("td").eq(6).text()) === bento_id_int) {
                                received_col = target_tr.find("td").eq(2) //已領欄位
                                not_received_col = target_tr.find("td").eq(3) //未領欄位
                                console.log("each tr:",$(this), received_col, not_received_col)

                                if (this_btn.val() === "未領取") {
                                    received_col.text((parseInt(received_col.text()) +
                                        order_number_int).toString())
                                    not_received_col.text((parseInt(
                                            not_received_col.text()) -
                                        order_number_int).toString())
                                } else {
                                    received_col.text((parseInt(received_col.text()) -
                                        order_number_int).toString())
                                    not_received_col.text((parseInt(
                                            not_received_col.text()) +
                                        order_number_int).toString())
                                }
                            }

                        })
                    }
                })

                // Update btn value
                if (this_btn.val() == "未領取") { // 領取部分
                    this_btn.val("已領取")
                } else if (this_btn.val() == "已領取") { // 取消領取部分
                    this_btn.val("未領取")
                }
                // Update btn style
                this_btn.toggleClass("btn-danger")
                this_btn.toggleClass("btn-default")
            },
            error: function (jqXHR, exception) {
                var msg = '';
                if (jqXHR.status === 0) {
                    msg = 'Not connect.\n Verify Network.';
                } else if (jqXHR.status == 404) {
                    msg = 'Requested page not found. [404]';
                } else if (jqXHR.status == 500) {
                    msg = 'Internal Server Error [500].';
                } else if (exception === 'parsererror') {
                    msg = 'Requested JSON parse failed.';
                } else if (exception === 'timeout') {
                    msg = 'Time out error.';
                } else if (exception === 'abort') {
                    msg = 'Ajax request aborted.';
                } else {
                    msg = 'Uncaught Error.\n' + jqXHR.responseText;
                }
                alert("請求失敗 " + msg)
            },
        })
    })

    var $rows = $('#orderList tbody tr');
    $("#searchInput").keyup(function () {
        var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();

        $rows.show().filter(function () {
            var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
            return !~text.indexOf(val);
        }).hide();
    })
</script>
{% endblock %}